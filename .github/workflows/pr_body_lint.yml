name: pr-body-lint

on:
  pull_request:
    types: [opened, edited, reopened, synchronize, ready_for_review]

jobs:
  lint:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/github-script@v8
        with:
          script: |
            const body = (context.payload.pull_request && context.payload.pull_request.body)
              ? context.payload.pull_request.body
              : "";

            const required = [
              { label: "## Scope", re: /(^|\n)##\s+Scope(\n|$)/m },
              { label: "## Validation", re: /(^|\n)##\s+Validation(\n|$)/m },
              { label: "## Revert Plan", re: /(^|\n)##\s+Revert Plan(\n|$)/m },
            ];

            const missing = required.filter((x) => !x.re.test(body)).map((x) => x.label);
            const trimmed = body.trim();
            const tooShort = trimmed.length < 40;

            if (missing.length === 0 && !tooShort) {
              core.info("PR body lint: PASS");
              return;
            }

            let msg = "PR body lint: FAIL\n\n";
            if (tooShort) msg += "- PR description is empty/too short.\n";
            if (missing.length) msg += "- Missing sections: " + missing.join(", ") + "\n";
            msg += "\nPlease fill the PR template sections (Scope / Validation / Revert Plan).";

            const marker = "<!-- pr-body-lint -->";
            const commentBody = `${marker}\n${msg}`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              per_page: 100,
            });

            const existing = comments.find(
              (c) =>
                c.user &&
                c.user.type === "Bot" &&
                typeof c.body === "string" &&
                c.body.includes(marker)
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: commentBody,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody,
              });
            }

            core.setFailed(msg);

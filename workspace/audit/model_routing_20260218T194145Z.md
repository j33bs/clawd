# Model Routing Audit (20260218T194145Z)

## Phase 0 Preflight

```bash
git status --porcelain -uall
?? jest.config.js
?? workspace/audit/model_routing_20260218T194145Z.md
```

```bash
git rev-parse --short HEAD
1f11547
```

```bash
node -v && npm -v
v22.22.0
10.9.4
```

```bash
python3 -V
Python 3.12.3
```

## Phase 1 Discovery Evidence

```bash
ls -la | rg -n "openclaw\.json" || true
# (no output)
```

```bash
find . -maxdepth 4 -iname "openclaw.json" -o -iname "*policy*.json" -o -iname "*routing*.json"
./workspace/policy/llm_policy.json
```

```bash
rg -n "openclaw\.json|llm_policy|policy_router|ProviderRegistry|routing|allowPaid|preferLocal" -S core workspace scripts tests
# Key hits:
# - workspace/policy/llm_policy.json
# - workspace/scripts/policy_router.py
# - workspace/scripts/verify_llm_policy.sh
# - workspace/scripts/verify_policy_router.sh
```

Decision: repo-root `openclaw.json` is not present. Canonical routing is `workspace/policy/llm_policy.json` + `workspace/scripts/policy_router.py`, so implementation was applied there (no new config surface added).

Backups created before edits:
- `workspace/audit/backups/20260218T194326Z/workspace/policy/llm_policy.json.bak`
- `workspace/audit/backups/20260218T194326Z/workspace/scripts/policy_router.py.bak`
- `workspace/audit/backups/20260218T194326Z/workspace/scripts/verify_policy_router.sh.bak`
- `workspace/audit/backups/20260218T194556Z/workspace/scripts/verify_coding_ladder.sh.bak`

## Phase 2-4 Implementation Summary

Authoritative policy updates (`workspace/policy/llm_policy.json`):
- Added conversation-capable providers:
  - `minimax_m25` -> `minimax-portal/MiniMax-M2.5`
  - `minimax_m25_lightning` -> `minimax-portal/MiniMax-M2.5-Lightning`
  - `openai_gpt52_chat` -> `gpt-5.2-chat-latest`
  - `openai_gpt53_codex` -> `gpt-5.3-codex`
  - `openai_gpt53_codex_spark` -> `gpt-5.3-codex-spark`
- Added `routing.intents.conversation` order with MiniMax M2.5 primary.
- Added `routing.capability_router` config for explicit triggers, subagent default, complexity escalation, and deterministic structure thresholds.
- Added local assistant context capability:
  - `providers.local_vllm_assistant.capabilities.context_window_tokens = 16384`
  - env override key: `LOCAL_ASSISTANT_CONTEXT_WINDOW_TOKENS`

Router updates (`workspace/scripts/policy_router.py`):
- Added deterministic trigger/complexity parser with auditable decisions.
- Implemented precedence (after eligibility checks):
  1. hard gates (`_provider_available`, circuit, budgets)
  2. explicit phrase triggers (primary-only):
     - `use chatgpt` -> `openai_gpt52_chat`
     - `use codex` -> `openai_gpt53_codex`
  3. subagent default -> `local_vllm_assistant`
  4. complexity escalation:
     - reasoning/planning -> `openai_gpt52_chat`
     - coding -> `openai_gpt53_codex`
     - small coding -> `openai_gpt53_codex_spark`
  5. default route order (MiniMax M2.5 first for conversation)
- Added `explain_route(intent, context_metadata, payload)` output with:
  - matched trigger/detail
  - chosen provider+model
  - fallback candidates
  - local context window token capability
- Added evidence-first route log event `router_route_selected` with trigger/reason/fallbacks.
- Added fallback intent behavior: unknown intents inherit `conversation` config when present.

## Phase 5 Tests

Policy verification scripts:

```bash
bash workspace/scripts/verify_llm_policy.sh
ok
```

```bash
bash workspace/scripts/verify_policy_router.sh
ok
```

```bash
bash workspace/scripts/verify_coding_ladder.sh
ok
```

Notes:
- `workspace/scripts/verify_policy_router.sh` extended with deterministic routing assertions:
  - default MiniMax M2.5
  - explicit `use chatgpt`
  - explicit `use codex`
  - subagent -> local assistant
  - reasoning -> gpt-5.2 chat
  - coding -> gpt-5.3 codex
  - small coding -> gpt-5.3 codex-spark
  - explain hook includes trigger + local context capability
- `workspace/scripts/verify_coding_ladder.sh` expected order was updated to match current canonical coding ladder with local-first entries.

Full test suite:

```bash
npm test
# Result: FAILURES: 3/17
# Existing unrelated failures observed in:
# - tests/redact_audit_evidence.test.js (CLI JSON summary parsing)
# - tests/system2_experiment.test.js (CLI exits 3)
# - tests/system2_snapshot_diff.test.js (JSON parse / human output expectations)
```

## Local 16k -> 32k Upgrade Path (Safe)

Current implemented capability:
- Local assistant context window is represented explicitly as `16384` tokens and surfaced in route explanations.
- Override path exists via `LOCAL_ASSISTANT_CONTEXT_WINDOW_TOKENS` env.

To move to 32k safely:
1. Confirm model actually supports 32k context.
2. Run vLLM with `--max-model-len 32768` for local assistant serving process.
3. Validate GPU KV-cache headroom (memory utilization / max-num-seqs) under expected concurrency.
4. Set `LOCAL_ASSISTANT_CONTEXT_WINDOW_TOKENS=32768` (or policy value) only after runtime confirmation.

## Known Limits / Hardening Next

- Complexity detection is deterministic keyword+structure based; no probabilistic classifier is used.
- Explicit triggers intentionally do not apply to subagents unless `explicitApplyToSubagents` is set true.
- `context_window_tokens` currently uses policy/env metadata; no live vLLM metadata probe was added because probing infra is not currently part of this router path.

## Follow-up Preflight (2026-02-19 governance check)

```bash
date -u +"%Y-%m-%dT%H:%M:%SZ"
2026-02-18T20:02:47Z
```

```bash
git status --porcelain -uall
?? jest.config.js
```

```bash
git rev-parse --short HEAD
529f0a7
```

```bash
git branch --show-current
feature/capability-routing-dali-20260219
```

## Phase 1A Jest Config Inspection

```bash
ls -la jest.config.js || true
-rw-rw-r-- 1 jeebs jeebs 488 Feb 19 00:17 jest.config.js
```

```bash
sed -n '1,240p' jest.config.js 2>/dev/null || true
'use strict';
// This repo uses a custom Node test runner (scripts/run_tests.js).
// Test files define their own test() shim and are NOT Jest-compatible.
// Use `npm test` â€” do not invoke jest directly.
//
// testRegex below never matches any real path; passWithNoTests prevents exit 1.
// If Jest-native tests are added in the future, put them under __jest__/ and
// update testRegex accordingly.
module.exports = {
  testRegex: '__jest__/.*\\.test\\.js$',
  passWithNoTests: true,
};
```

```bash
git diff -- jest.config.js || true
# (no output; untracked file)
```

```bash
git ls-files --error-unmatch jest.config.js >/dev/null 2>&1 && echo "TRACKED" || echo "UNTRACKED"
UNTRACKED
```

```bash
rg -n "jest(\.config)?|testEnvironment|transform|moduleNameMapper" package.json -n || true
# (no output)
```

```bash
rg -n "jest\.config\.js" -S .gitignore package.json workspace scripts tests || true
workspace/audit/model_routing_20260218T194145Z.md:7:?? jest.config.js
workspace/audit/model_routing_20260218T194145Z.md:161:?? jest.config.js
```

Phase 1B decision: delete `jest.config.js` (untracked, redundant, repo uses `scripts/run_tests.js`, no Jest config surface in tracked project files).

## Phase 2A Branch Test Capture

Branch under test: `feature/capability-routing-dali-20260219` @ `529f0a7`

Command:
```bash
npm test 2>&1 | tee workspace/audit/npm_test_branch_20260219.txt || true
```

Failure signatures (from `workspace/audit/npm_test_branch_20260219.txt`):
- `tests/redact_audit_evidence.test.js`
  - `FAIL CLI redacts synthetic fixtures and writes output bundle: CLI should emit JSON summary`
  - `FAIL CLI dry-run emits summary and does not write output files: Unexpected end of JSON input`
- `tests/system2_experiment.test.js`
  - `FAIL no-change fixture yields INCONCLUSIVE: CLI failed (3):`
  - `FAIL improvement fixture yields KEEP: CLI failed (3):`
  - `FAIL regression fixture yields REVERT: CLI failed (3):`
  - `FAIL calibrated auth fail-on yields REVERT on regression fixture: CLI failed (3):`
- `tests/system2_snapshot_diff.test.js`
  - `FAIL JSON output is stable and ignores timestamp fields by default: Unexpected end of JSON input`
  - `FAIL ignore list suppresses expected diff paths and exits 0: Unexpected end of JSON input`
  - `FAIL fail-on marks regressions and exits 2: Unexpected end of JSON input`
  - `FAIL human output includes summary counts and regression marker: human output should include counts`

## Phase 2B Main Baseline + Classification

Attempted remote update:
```bash
git fetch origin
# ssh: Could not resolve hostname github.com: Temporary failure in name resolution
```

```bash
git checkout main
# switched successfully after temporary stash of audit file
```

```bash
git pull --ff-only
# ssh: Could not resolve hostname github.com: Temporary failure in name resolution
```

Main baseline tested at local SHA:
```bash
git rev-parse --short HEAD | tee -a workspace/audit/main_head_20260219.txt
560e30e
```

Main test capture:
```bash
npm test 2>&1 | tee workspace/audit/npm_test_main_20260219.txt || true
```

Classification result:
- Branch SHA tested: `529f0a7`
- Main SHA tested (local): `560e30e`
- Same failing suites and materially same first-failure signatures on both branch and main:
  - `tests/redact_audit_evidence.test.js`
  - `tests/system2_experiment.test.js`
  - `tests/system2_snapshot_diff.test.js`
- Decision per rule: **pre-existing non-green baseline on main** (not introduced by this branch).

## Phase 3 Baseline Non-Green (No Unrelated Fixes)

Confirmed pre-existing failing suites on `main` local baseline:
- `tests/redact_audit_evidence.test.js`
- `tests/system2_experiment.test.js`
- `tests/system2_snapshot_diff.test.js`

Remediation scope decision:
- No unrelated suite fixes applied in this branch.
- Acceptance gates for routing changes remain:
  - `bash workspace/scripts/verify_llm_policy.sh`
  - `bash workspace/scripts/verify_policy_router.sh`
  - `bash workspace/scripts/verify_coding_ladder.sh`
- No additional gate runner added (existing verify script pattern already present and consistent).

## Phase 4 Final Evidence

```bash
git status --porcelain -uall
 M workspace/audit/model_routing_20260218T194145Z.md
?? workspace/audit/main_head_20260219.txt
?? workspace/audit/npm_test_branch_20260219.txt
?? workspace/audit/npm_test_main_20260219.txt
```

```bash
git diff --stat
 workspace/audit/model_routing_20260218T194145Z.md | 145 ++++++++++++++++++++++
 1 file changed, 145 insertions(+)
```

```bash
git log --oneline -n 8
529f0a7 feat(routing): capability-based model routing with explicit triggers + subagent local default
1f11547 sec(repo): untrack credentials + workspace artifacts (keep local)
560e30e feat(sim_b): consume ITC contract with bounded tilt and smoke tests
396ed9b feat(itc): add pluggable ingest and signal selection API
0184248 docs(itc): add contract brief and v1 schema fixtures
c0962c9 fix(policy-router): make openai-compatible key requirements explicit and verify anthropic fallback
87c7056 fix(telegram-check): add redacted status-unavailable diagnostics for openclaw
46c66bc fix(router): allow keyless openai-compatible fallback
```

## Governance Finalization Preflight (origin/main validation)

```bash
date -u +"%Y-%m-%dT%H:%M:%SZ"
2026-02-18T21:48:19Z
```

```bash
git status --porcelain -uall
# (clean)
```

```bash
git rev-parse --short HEAD
3dd3506
```

```bash
git branch --show-current
feature/capability-routing-dali-20260219
```

## Phase 1 Network/DNS Evidence (origin fetch prerequisite)

```bash
cat /etc/resolv.conf || true
# This is /run/systemd/resolve/stub-resolv.conf managed by man:systemd-resolved(8).
# Do not edit.
#
# This file might be symlinked as /etc/resolv.conf. If you're looking at
# /etc/resolv.conf and seeing this text, you have followed the symlink.
#
# This is a dynamic resolv.conf file for connecting local clients to the
# internal DNS stub resolver of systemd-resolved. This file lists all
# configured search domains.
#
# Run "resolvectl status" to see details about the uplink DNS servers
# currently in use.
#
# Third party programs should typically not access this file directly, but only
# through the symlink at /etc/resolv.conf. To manage man:resolv.conf(5) in a
# different way, replace this symlink by a static file or a different symlink.
#
# See man:systemd-resolved.service(8) for details about the supported modes of
# operation for /etc/resolv.conf.

nameserver 127.0.0.53
options edns0 trust-ad
search modem
```

```bash
getent hosts github.com || true
# (no output)
```

```bash
resolvectl status 2>/dev/null || true
# (no output)
```

```bash
nmcli dev show 2>/dev/null | rg -n "DNS|IP4.DNS|IP6.DNS|IP4.GATEWAY|GENERAL.DEVICE" || true
# (no output)
```

Quick restart attempts (errors suppressed by command design):
```bash
sudo systemctl restart systemd-resolved 2>/dev/null || true
sudo systemctl restart NetworkManager 2>/dev/null || true
```

Re-test:
```bash
getent hosts github.com
# (no output)
```

```bash
git fetch origin
ssh: Could not resolve hostname github.com: Temporary failure in name resolution
fatal: Could not read from remote repository.

Please make sure you have the correct access rights
and the repository exists.
```

```bash
git rev-parse --short origin/main
560e30e
```

Status: fetch to origin failed after DNS/service recovery attempts. Per instruction, workflow is stopped here with explicit failure evidence.

# Dali 6-Hour Autonomous Audit & Repair

- UTC start: 2026-02-22T16:01:16Z
- Branch: codex/chore/dali-6h-autonomous-audit-repair-20260223
- Base HEAD: 005b912e63e2ea7c378c267d2bfc7a99581632f2
- Primary evidence base: `workspace/audit/system-audit-20260222.md`

## Objectives
1. Restore local vLLM fallback service health without weakening security.
2. Verify durable pairing guardrails and cron preflight path stability.
3. Apply plugin allowlist hardening.
4. Add bounded log rotation for `/tmp/openclaw` growth.
5. Correct cron payload kind mismatches causing skipped/error runs.
6. Reconcile workspace drift with `~/src/clawd/workspace` as source of truth.
7. Resolve `WORKFLOW_AUTO.md` reference gap appropriately.
8. Run `openclaw doctor --repair` and keep only safe/reversible outcomes.

## Constraints
- Minimal diffs, reversible, evidence-first.
- No disabling pairing/auth, no auto-approve.
- No secrets printed or committed.
- Prefer config/service/docs changes over runtime code changes.

## Kill-Switch Criteria (STOP and ask)
- Any step would expose/rotate secrets.
- Any step would weaken auth/pairing posture.
- Any step would delete user data without backup.
- Any doctor-proposed action is ambiguous or architecture-altering.

## Phase 0 - Baseline & Safety
```bash
$ pwd
/tmp/wt_local_exec_activation

$ git status --porcelain -uall
(no output)

$ git rev-parse --abbrev-ref HEAD
codex/chore/dali-gateway-pairing-preflight-20260223

$ git rev-parse HEAD
005b912e63e2ea7c378c267d2bfc7a99581632f2

$ command -v openclaw && openclaw --version
/home/jeebs/.local/bin/openclaw
2026.2.19-2 build_sha=9325318d0c992f1e5395a7274f98220ca7999336 build_time=2026-02-22T04:58:13Z

$ systemctl --user status openclaw-gateway.service --no-pager
active (running)

$ systemctl --user status openclaw-vllm.service --no-pager || true
inactive (dead); last failure indicates engine core init failure

$ ss -ltnp | grep 18789 || true
LISTEN 127.0.0.1:18789 and [::1]:18789 via openclaw-gateway
```

Decision:
- Proceed. Worktree clean and gateway is stable on loopback.
- vLLM inactive with explicit error evidence; targeted recovery needed.

## Phase 1 - Pairing Guardrails Verification
```bash
$ workspace/scripts/check_gateway_pairing_health.sh
INFO: recent scope-upgrade/pairing-required log lines were found; ensure devices list remains pending-free.
OK: no pending pairing/repair detected.
(exit_code=0)

$ command -v openclaw-cron-preflight
/home/jeebs/.local/bin/openclaw-cron-preflight

$ crontab -l | sed -n "1,120p"
# OpenClaw maintenance
30 2 * * * $HOME/.local/bin/openclaw-cron-preflight -- $HOME/bin/openclaw-backup.sh >> $HOME/.local/state/openclaw/backup.log 2>&1
45 3 * * * $HOME/bin/python-env-audit.sh $HOME/security-audits >> $HOME/.local/state/openclaw/python-audit.log 2>&1
15 4 * * * $HOME/bin/cleanup-temp.sh >> $HOME/.local/state/openclaw/cleanup.log 2>&1
*/5 * * * * $HOME/bin/system-monitor.sh >> $HOME/.local/state/openclaw/monitor-cron.log 2>&1
```
Decision:
- Guardrails healthy: preflight exits 0 and stable shim path is in use (no /tmp wrapper in cron).

## Phase 2 - vLLM Recovery
```bash
$ systemctl --user cat openclaw-vllm.service
ExecStart=/home/jeebs/src/clawd/.venv-vllm/bin/python3.12 ... vllm serve /opt/models/qwen2_5_14b_instruct_awq ... --host 127.0.0.1 --port 8001 --gpu-memory-utilization 0.90 ...

$ ls -la /opt/models/qwen2_5_14b_instruct_awq
(exists; model shards present)

$ manual bounded startup test (timeout 60s)
(model loaded and API server reached 127.0.0.1:8001 before timeout)

$ systemctl --user enable openclaw-vllm.service && restart
$ curl -fsS http://127.0.0.1:8001/health
(HTTP 200, empty body)

$ systemctl --user status openclaw-vllm.service
Active: active (running) since 02:11:07; verified at 10min uptime
```
Decision:
- No service-file argument changes required; prior failure was transient low-free-GPU state. Recovery achieved by controlled restart/enable and validation.

## Phase 3 - Plugin Allowlist Hardening
```bash
$ python inspection of ~/.openclaw/openclaw.json plugins section
plugins.keys = [entries, installs, load], plugins.allow missing

$ backup + set plugins.allow to existing configured entries + restart gateway
plugins.allow set to: [llm-task, minimax-portal-auth, openclaw_secrets_plugin, telegram]
gateway plugin auto-load warning cleared
```
Decision:
- Added explicit allowlist only for already-configured plugins; no privilege broadening.

## Phase 4 - /tmp/openclaw Log Rotation
```bash
$ du -sh /tmp/openclaw (before)
2.4M /tmp/openclaw

$ create ~/.config/logrotate/openclaw-tmp.conf
/tmp/openclaw/openclaw-*.log { daily rotate 7 compress delaycompress missingok notifempty copytruncate }

$ /usr/sbin/logrotate -v -s ~/.local/state/openclaw/logrotate.status ~/.config/logrotate/openclaw-tmp.conf
reading config file /home/jeebs/.config/logrotate/openclaw-tmp.conf
Creating stub state file: /home/jeebs/.local/state/openclaw/logrotate.status
acquired lock on state file /home/jeebs/.local/state/openclaw/logrotate.statusReading state from file: /home/jeebs/.local/state/openclaw/logrotate.status
Allocating hash table for state file, size 64 entries

Handling 1 logs

rotating pattern: /tmp/openclaw/openclaw-*.log  after 1 days (7 rotations)
empty log files are not rotated, old logs are removed
considering log /tmp/openclaw/openclaw-2026-02-22.log
Creating new state
  Now: 2026-02-23 02:22
  Last rotated at 2026-02-23 02:00
  log does not need rotating (log has already been rotated)
considering log /tmp/openclaw/openclaw-2026-02-23.log
Creating new state
  Now: 2026-02-23 02:22
  Last rotated at 2026-02-23 02:00
  log does not need rotating (log has already been rotated)

$ added user cron
50 2 * * * /usr/sbin/logrotate -s $HOME/.local/state/openclaw/logrotate.status $HOME/.config/logrotate/openclaw-tmp.conf >> $HOME/.local/state/openclaw/logrotate.log 2>&1
```

## Phase 5 - Cron Payload Kind Corrections
```bash
$ backup ~/.openclaw/cron/jobs.json
$ openclaw cron edit consciousness-timer-hourly --message ...
$ openclaw cron edit dream-consolidation-nightly --message ...
$ openclaw cron edit 34e55f64-755d-4d01-8bda-6db054126e6e --system-event ...

$ post-edit payload kinds
consciousness-timer-hourly -> agentTurn (isolated)
dream-consolidation-nightly -> agentTurn (isolated)
34e55f64-... (daily-brief-630am) -> systemEvent (main)

$ openclaw cron run (verification)
consciousness-timer-hourly: ok=true ran=true
dream-consolidation-nightly: ok=true ran=true
daily-brief-630am: gateway timeout after 45000ms (no payload.kind contract error)
```
Decision:
- Fixed only payload kind/type contract fields; schedules unchanged.

## Phase 6 - Workspace Drift Reconciliation (Backup-first)
```bash
$ du -sh ~/.openclaw/workspace ~/src/clawd/workspace
500K vs 725M

$ tar backup
/home/jeebs/.openclaw/workspace_backup_20260222T161855Z.tar.gz

$ targeted sync of governance files (non-destructive, no delete)
Synced: AGENTS.md BOOTSTRAP.md CONSTITUTION.md HEARTBEAT.md IDENTITY.md MEMORY.md SOUL.md TOOLS.md USER.md

$ hash check before/after
After sync: SRC and DST hashes match for all listed governance files.
```

## Phase 7 - WORKFLOW_AUTO.md
```bash
$ rg -n "WORKFLOW_AUTO" .
No existing operational document found (only this audit reference).

$ created workspace/WORKFLOW_AUTO.md (minimal automation guardrails)
$ copied to ~/.openclaw/workspace/WORKFLOW_AUTO.md for runtime path compatibility
```

## Phase 8 - openclaw doctor --repair
```bash
$ openclaw doctor --repair
Exit 0. Findings included: gateway token/path recommendations, memory plugin warning, memory-search provider missing.
Doctor suggested "openclaw doctor --fix" for automatic changes.
```
Decision:
- Did NOT run --fix automatically to avoid ambiguous/risky config rewrites without explicit review.

## Phase 9 - System Verification
```bash
$ openclaw status
Gateway loopback and running; sessions active.

$ openclaw health
Telegram ok; agent session store healthy.

$ workspace/scripts/check_gateway_pairing_health.sh
FAIL: Gateway pairing/repair is pending (1008 pairing required likely).

Pending requests:
- request_id=b4497d11-2147-40bb-a96b-07bbb0bbb875 client_id=gateway-client status=<unknown_status> scopes=operator.write

Remediation:
  openclaw devices list --json
  openclaw devices approve <REQUEST_ID>
  # If logs show reason=scope-upgrade, verify required scopes then approve.
(exit_code=2)

$ ~/.local/bin/openclaw-cron-preflight -- echo CRON_SHIM_OK
FAIL: Gateway pairing/repair is pending (1008 pairing required likely).

Pending requests:
- request_id=b4497d11-2147-40bb-a96b-07bbb0bbb875 client_id=gateway-client status=<unknown_status> scopes=operator.write

Remediation:
  openclaw devices list --json
  openclaw devices approve <REQUEST_ID>
  # If logs show reason=scope-upgrade, verify required scopes then approve.
PRECHECK FAILED: gateway pairing/repair pending; aborting job (see guard output above)
(exit_code=2)
```
Decision:
- Fail-closed behavior verified: pending gateway-client repair request is detected and cron shim blocks execution with non-zero exit.
- No auto-approval performed (security constraint preserved).

## Phase 9.1 - Wrapper Exit-Code Repair
- Found and fixed bug in `workspace/scripts/cron_with_gateway_preflight.sh` where failing precheck returned exit 0 due `if ! cmd; then status=$?` inversion semantics.
- New behavior: capture guard exit status explicitly and propagate non-zero codes.

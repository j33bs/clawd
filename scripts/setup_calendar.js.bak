/**
 * setup_calendar.js
 * 
 * Setup script for calendar integration
 * Helps configure calendar credentials and initialize the integration
 */

const CalendarIntegration = require('./calendar_integration.js');
const fs = require('fs').promises;
const path = require('path');

async function setupCalendarIntegration() {
  console.log("üìÖ OpenClaw Calendar Integration Setup");
  console.log("=====================================");
  
  // Load configuration
  let config = {};
  try {
    const configData = await fs.readFile('./config/calendar_config.json', 'utf8');
    config = JSON.parse(configData);
  } catch (error) {
    console.log("‚ö†Ô∏è  Configuration file not found, using defaults");
    config.calendarIntegration = {
      enabled: true,
      provider: "apple_caldav",
      serverUrl: "https://caldav.icloud.com",
      calendarFile: "./calendar_data.json",
      syncInterval: 1800000,
      defaultViewRange: 7,
      autoSync: true,
      credentials: {
        username: "",
        password: ""
      }
    };
  }
  
  if (!config.calendarIntegration.enabled) {
    console.log("‚ùå Calendar integration is disabled in configuration");
    return;
  }
  
  console.log("\nTo set up calendar integration, you'll need:");
  console.log("1. Your calendar service email (e.g., yourname@icloud.com for Apple Calendar)");
  console.log("2. An app-specific password from your account");
  
  console.log("\nFor Apple Calendar:");
  console.log("- Go to appleid.apple.com");
  console.log("- Sign in with your Apple ID");
  console.log("- Go to Security > Generate Passwords");
  console.log("- Create a new app-specific password for 'OpenClaw'");
  
  console.log("\nFor other calendar services:");
  console.log("- Google Calendar: Enable CalDAV and use your Google account");
  console.log("- Outlook: May require specific CalDAV settings");
  
  console.log("\nüìù Configuration Details:");
  console.log(`   Provider: ${config.calendarIntegration.provider}`);
  console.log(`   Server URL: ${config.calendarIntegration.serverUrl}`);
  console.log(`   Sync Interval: ${config.calendarIntegration.syncInterval / 60000} minutes`);
  console.log(`   Data File: ${config.calendarIntegration.calendarFile}`);
  
  // Create the calendar integration instance
  const calendar = new CalendarIntegration({
    calendarFile: config.calendarIntegration.calendarFile,
    serverUrl: config.calendarIntegration.serverUrl,
    syncInterval: config.calendarIntegration.syncInterval
  });
  
  console.log("\nüß™ Testing calendar integration setup...");
  
  // Attempt to initialize with empty credentials (will fail as expected)
  console.log("\nüí° To complete setup, you need to provide your calendar credentials.");
  console.log("You can do this by setting environment variables:");
  console.log("");
  console.log("export CALENDAR_USERNAME='your_email@domain.com'");
  console.log("export CALENDAR_PASSWORD='your_app_specific_password'");
  console.log("");
  console.log("Then run the integration with:");
  console.log("node -e \"const CalendarIntegration = require('./calendar_integration.js'); const cal = new CalendarIntegration(); cal.initialize({username: process.env.CALENDAR_USERNAME, password: process.env.CALENDAR_PASSWORD}).then(() => console.log('‚úÖ Success!')).catch(e => console.error('‚ùå Error:', e.message));\"");
  
  console.log("\nüîÑ Alternatively, you can use this helper function:");
  
  console.log(`
    // In your application:
    const CalendarIntegration = require('./calendar_integration.js');

    async function initializeCalendar() {
      const calendar = new CalendarIntegration({
        calendarFile: '${config.calendarIntegration.calendarFile}',
        serverUrl: '${config.calendarIntegration.serverUrl}',
        syncInterval: ${config.calendarIntegration.syncInterval}
      });
      
      try {
        await calendar.initialize({
          username: process.env.CALENDAR_USERNAME,  // Your calendar email
          password: process.env.CALENDAR_PASSWORD   // Your app-specific password
        });
        
        // Start automatic synchronization
        calendar.startAutoSync();
        
        // Test the connection
        const testResult = await calendar.testConnection();
        console.log('Calendar connection test:', testResult.connected ? '‚úÖ Success' : '‚ùå Failed');
        
        // Get availability summary
        const summary = await calendar.getAvailabilitySummary(7);
        console.log('Availability for next 7 days:', summary.summary.availabilityPercentage + '% free');
        
        return calendar;
      } catch (error) {
        console.error('Calendar initialization failed:', error.message);
        throw error;
      }
    }

    // Call the function
    initializeCalendar().catch(console.error);
  `);
  
  console.log("\nüìã Once configured, the calendar integration will:");
  console.log("   ‚Ä¢ Automatically sync your calendar events every", config.calendarIntegration.syncInterval / 60000, "minutes");
  console.log("   ‚Ä¢ Provide availability summaries based on your real schedule");
  console.log("   ‚Ä¢ Store calendar data locally in", config.calendarIntegration.calendarFile);
  console.log("   ‚Ä¢ Detect busy periods and free time for planning");
  
  return calendar;
}

// Run setup if this file is executed directly
if (require.main === module) {
  setupCalendarIntegration()
    .then(() => {
      console.log("\n‚úÖ Calendar integration setup instructions complete!");
      console.log("Follow the instructions above to finish the configuration.");
    })
    .catch(error => {
      console.error("‚ùå Error during setup:", error);
    });
}

module.exports = { setupCalendarIntegration };
